<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Optimizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <main class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Resume Optimizer (Advanced)</h1>
        <a class="btn btn-outline-secondary btn-sm" href="/">Back to Main Page</a>
      </div>

      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <label class="form-label">Job Ad</label>
              <textarea id="jobAd" class="form-control" rows="10" placeholder="Paste job ad..."></textarea>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <label class="form-label">Personal Info (synced with main page)</label>
              <textarea id="personalInfo" class="form-control" rows="10" placeholder="Paste your current personal info snippets..."></textarea>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                <button id="savePersonalBtn" class="btn btn-success btn-sm">Save</button>
                <button id="clearPersonalBtn" class="btn btn-outline-danger btn-sm">Clear</button>
                <button id="updateInfoBtn" class="btn btn-outline-primary btn-sm">Update Info from Parsed Resume</button>
              </div>
              <div id="personalStatus" class="small text-secondary mt-2">Personal info sync ready.</div>
              <label class="form-label mt-3">Resume (.docx)</label>
              <input id="resumeUpload" class="form-control" type="file" accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 d-grid gap-2">
        <label for="specialInstructions" class="form-label mb-0">Special Instructions (for LLM optimized resume generation)</label>
        <textarea id="specialInstructions" class="form-control" rows="4" placeholder="e.g. Keep tone concise, prioritize service desk KPI achievements, avoid mentioning technologies not in resume."></textarea>
        <button id="parseBtn" class="btn btn-outline-primary">1) Parse Resume</button>
        <button id="optimizeBtn" class="btn btn-primary">2) Run Advanced Optimization</button>
        <button id="generateDocxBtn" class="btn btn-success">3) Generate Optimized DOCX</button>
        <div id="status" class="small text-secondary">Waiting for input...</div>
      </div>

      <div class="row g-4 mt-1">
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Parsed Resume</h2>
              <pre id="parsedOut" class="form-control" style="min-height:220px;white-space:pre-wrap"></pre>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Optimization Output</h2>
              <pre id="optOut" class="form-control" style="min-height:220px;white-space:pre-wrap"></pre>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const PERSONAL_INFO_KEY = 'job-hunt-personal-info-v1'

      const parseBtn = document.getElementById('parseBtn')
      const optimizeBtn = document.getElementById('optimizeBtn')
      const generateDocxBtn = document.getElementById('generateDocxBtn')
      const savePersonalBtn = document.getElementById('savePersonalBtn')
      const clearPersonalBtn = document.getElementById('clearPersonalBtn')
      const updateInfoBtn = document.getElementById('updateInfoBtn')
      const personalStatus = document.getElementById('personalStatus')
      const upload = document.getElementById('resumeUpload')
      const jobAdEl = document.getElementById('jobAd')
      const personalInfoEl = document.getElementById('personalInfo')
      const specialInstructionsEl = document.getElementById('specialInstructions')
      const parsedOut = document.getElementById('parsedOut')
      const optOut = document.getElementById('optOut')
      const statusEl = document.getElementById('status')

      let parsedResume = null

      function loadPersonalInfo() {
        const saved = localStorage.getItem(PERSONAL_INFO_KEY)
        if (saved) {
          personalInfoEl.value = saved
          personalStatus.textContent = 'Loaded synced personal info from browser storage.'
          personalStatus.className = 'small text-success mt-2'
        }
      }

      savePersonalBtn.addEventListener('click', () => {
        localStorage.setItem(PERSONAL_INFO_KEY, personalInfoEl.value || '')
        personalStatus.textContent = 'Personal info saved and synced.'
        personalStatus.className = 'small text-success mt-2'
      })

      clearPersonalBtn.addEventListener('click', () => {
        localStorage.removeItem(PERSONAL_INFO_KEY)
        personalInfoEl.value = ''
        personalStatus.textContent = 'Personal info cleared from sync storage.'
        personalStatus.className = 'small text-danger mt-2'
      })

      updateInfoBtn.addEventListener('click', async () => {
        if (!parsedResume) {
          personalStatus.textContent = 'Parse resume first, then update info.'
          personalStatus.className = 'small text-danger mt-2'
          return
        }

        try {
          const r = await fetch('/api/summarize-personal-info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ parsedResume }),
          })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'summary failed')

          personalInfoEl.value = (j.snippets || []).map((s) => `- ${s}`).join('\n')
          localStorage.setItem(PERSONAL_INFO_KEY, personalInfoEl.value)
          personalStatus.textContent = `Personal info updated from parsed resume (${j.mode}).`
          personalStatus.className = 'small text-success mt-2'
        } catch (e) {
          personalStatus.textContent = e.message
          personalStatus.className = 'small text-danger mt-2'
        }
      })

      parseBtn.addEventListener('click', async () => {
        const f = upload.files?.[0]
        if (!f) {
          statusEl.textContent = 'Upload resume first.'
          statusEl.className = 'small text-danger'
          return
        }
        statusEl.textContent = 'Parsing resume...'
        statusEl.className = 'small text-secondary'

        try {
          const form = new FormData()
          form.append('resume', f)
          const r = await fetch('/api/parse-resume', { method: 'POST', body: form })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'parse failed')
          parsedResume = j.parsed
          parsedOut.textContent = JSON.stringify(j.parsed, null, 2)
          statusEl.textContent = 'Resume parsed.'
          statusEl.className = 'small text-success'
        } catch (e) {
          statusEl.textContent = e.message
          statusEl.className = 'small text-danger'
        }
      })

      optimizeBtn.addEventListener('click', async () => {
        if (!jobAdEl.value.trim()) {
          statusEl.textContent = 'Paste job ad first.'
          statusEl.className = 'small text-danger'
          return
        }

        statusEl.textContent = 'Running advanced optimization...'
        statusEl.className = 'small text-secondary'

        try {
          const r = await fetch('/api/advanced-optimize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jobAd: jobAdEl.value,
              personalInfo: personalInfoEl.value,
              parsedResume,
              specialInstructions: specialInstructionsEl.value,
            }),
          })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'optimize failed')
          optOut.textContent = JSON.stringify(j, null, 2)
          if (Array.isArray(j.improvedPersonalInfoSnippets) && j.improvedPersonalInfoSnippets.length) {
            personalInfoEl.value = j.improvedPersonalInfoSnippets.map((s) => `- ${s}`).join('\n')
            localStorage.setItem(PERSONAL_INFO_KEY, personalInfoEl.value)
            personalStatus.textContent = 'Updated personal info from optimizer and synced.'
            personalStatus.className = 'small text-success mt-2'
          }
          statusEl.textContent = `Optimization complete (${j.mode}).`
          statusEl.className = 'small text-success'
        } catch (e) {
          statusEl.textContent = e.message
          statusEl.className = 'small text-danger'
        }
      })

      generateDocxBtn.addEventListener('click', async () => {
        statusEl.textContent = 'Generating optimized DOCX...'
        statusEl.className = 'small text-secondary'

        try {
          const r = await fetch('/api/generate-optimized-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ specialInstructions: specialInstructionsEl.value }),
          })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'docx generation failed')

          statusEl.innerHTML = `DOCX generated. <a href="${j.downloadUrl}" target="_blank" rel="noopener">Download ${j.file}</a>`
          statusEl.className = 'small text-success'
        } catch (e) {
          statusEl.textContent = e.message
          statusEl.className = 'small text-danger'
        }
      })

      loadPersonalInfo()
    </script>
  </body>
</html>
