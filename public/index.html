<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Hunt Workspace (Unified)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background: #f6f8fb; }
      textarea { min-height: 180px; resize: vertical; }
      pre { white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <main class="container py-4">
      <h1 class="h3 mb-1">Job Hunt Workspace (Unified)</h1>
      <p class="text-secondary">One-page flow: personal info + job ad + resume + notes â†’ optimized resume + tailored cover letter.</p>

      <div class="row g-3">
        <div class="col-lg-6">
          <label class="form-label">Job Ad</label>
          <textarea id="jobAd" class="form-control" placeholder="Paste the full job ad"></textarea>
        </div>
        <div class="col-lg-6">
          <label class="form-label">Sample Cover Letter</label>
          <textarea id="sampleCoverLetter" class="form-control" placeholder="Paste your base cover letter"></textarea>
        </div>
        <div class="col-lg-6">
          <label class="form-label">Personal Info (synced)</label>
          <textarea id="personalInfo" class="form-control" placeholder="Your profile, skills, certs, achievements"></textarea>
          <label class="form-label mt-3">Your Name</label>
          <input id="yourName" class="form-control" placeholder="e.g. Mushy" />
          <div class="mt-2 d-flex gap-2 flex-wrap">
            <button id="saveInfoBtn" class="btn btn-success btn-sm">Save</button>
            <button id="clearInfoBtn" class="btn btn-outline-danger btn-sm">Clear</button>
            <button id="updateInfoBtn" class="btn btn-outline-primary btn-sm">Update Info from Parsed Resume</button>
          </div>
          <div id="infoStatus" class="small text-secondary mt-2">Ready</div>
        </div>
        <div class="col-lg-6">
          <label class="form-label">Special Instructions (for LLM)</label>
          <textarea id="specialInstructions" class="form-control" placeholder="e.g. Keep concise, prioritize KPI outcomes, avoid adding technologies not in resume"></textarea>
          <label class="form-label mt-3">Upload Old Resume (.docx recommended)</label>
          <input id="resumeUpload" type="file" class="form-control" accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
          <div id="fileStatus" class="small text-secondary mt-2">No file selected</div>
        </div>
      </div>

      <div class="mt-4 d-grid gap-2">
        <button id="parseResumeBtn" class="btn btn-outline-secondary">1) Parse Resume</button>
        <button id="generateAllBtn" class="btn btn-primary">2) Generate Optimized Resume + Cover Letter</button>
        <div id="status" class="small text-secondary">Waiting for input...</div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Parsed Resume JSON</h2>
              <pre id="parsedResumeOut" class="form-control" style="min-height:180px"></pre>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Extracted Job JSON</h2>
              <pre id="extractionOut" class="form-control" style="min-height:180px"></pre>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Optimizer Suggestions</h2>
              <pre id="suggestionsOut" class="form-control" style="min-height:180px"></pre>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h2 class="h6">Tailored Cover Letter</h2>
              <pre id="coverLetterOut" class="form-control" style="min-height:180px"></pre>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const PERSONAL_INFO_KEY = 'job-hunt-personal-info-v1'

      const jobAdEl = document.getElementById('jobAd')
      const sampleEl = document.getElementById('sampleCoverLetter')
      const personalInfoEl = document.getElementById('personalInfo')
      const yourNameEl = document.getElementById('yourName')
      const specialEl = document.getElementById('specialInstructions')
      const uploadEl = document.getElementById('resumeUpload')
      const fileStatus = document.getElementById('fileStatus')
      const statusEl = document.getElementById('status')
      const infoStatus = document.getElementById('infoStatus')
      const parsedOut = document.getElementById('parsedResumeOut')
      const extractionOut = document.getElementById('extractionOut')
      const suggestionsOut = document.getElementById('suggestionsOut')
      const coverLetterOut = document.getElementById('coverLetterOut')

      const saveInfoBtn = document.getElementById('saveInfoBtn')
      const clearInfoBtn = document.getElementById('clearInfoBtn')
      const updateInfoBtn = document.getElementById('updateInfoBtn')
      const parseResumeBtn = document.getElementById('parseResumeBtn')
      const generateAllBtn = document.getElementById('generateAllBtn')

      let parsedResume = null

      function loadInfo() {
        const saved = localStorage.getItem(PERSONAL_INFO_KEY)
        if (saved) personalInfoEl.value = saved
      }

      saveInfoBtn.addEventListener('click', () => {
        localStorage.setItem(PERSONAL_INFO_KEY, personalInfoEl.value || '')
        infoStatus.textContent = 'Saved personal info.'
        infoStatus.className = 'small text-success mt-2'
      })

      clearInfoBtn.addEventListener('click', () => {
        localStorage.removeItem(PERSONAL_INFO_KEY)
        personalInfoEl.value = ''
        infoStatus.textContent = 'Cleared personal info.'
        infoStatus.className = 'small text-danger mt-2'
      })

      uploadEl.addEventListener('change', () => {
        const f = uploadEl.files?.[0]
        fileStatus.textContent = f ? `Selected: ${f.name} (${Math.round(f.size/1024)} KB)` : 'No file selected'
      })

      parseResumeBtn.addEventListener('click', async () => {
        const f = uploadEl.files?.[0]
        if (!f) {
          statusEl.textContent = 'Upload resume first.'
          statusEl.className = 'small text-danger'
          return
        }
        statusEl.textContent = 'Parsing resume...'
        statusEl.className = 'small text-secondary'

        const form = new FormData()
        form.append('resume', f)

        try {
          const r = await fetch('/api/parse-resume', { method: 'POST', body: form })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'parse failed')
          parsedResume = j.parsed
          parsedOut.textContent = JSON.stringify(j.parsed, null, 2)
          statusEl.textContent = 'Resume parsed.'
          statusEl.className = 'small text-success'
        } catch (e) {
          statusEl.textContent = e.message
          statusEl.className = 'small text-danger'
        }
      })

      updateInfoBtn.addEventListener('click', async () => {
        if (!parsedResume) {
          infoStatus.textContent = 'Parse resume first.'
          infoStatus.className = 'small text-danger mt-2'
          return
        }
        try {
          const r = await fetch('/api/summarize-personal-info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ parsedResume }),
          })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'summary failed')
          personalInfoEl.value = (j.snippets || []).map((s) => `- ${s}`).join('\n')
          localStorage.setItem(PERSONAL_INFO_KEY, personalInfoEl.value)
          infoStatus.textContent = `Updated from parsed resume (${j.mode}).`
          infoStatus.className = 'small text-success mt-2'
        } catch (e) {
          infoStatus.textContent = e.message
          infoStatus.className = 'small text-danger mt-2'
        }
      })

      generateAllBtn.addEventListener('click', async () => {
        const f = uploadEl.files?.[0]
        if (!f) {
          statusEl.textContent = 'Upload resume first.'
          statusEl.className = 'small text-danger'
          return
        }
        if (!jobAdEl.value.trim() || !sampleEl.value.trim()) {
          statusEl.textContent = 'Job ad and sample cover letter are required.'
          statusEl.className = 'small text-danger'
          return
        }

        statusEl.textContent = 'Generating package (resume + cover letter)...'
        statusEl.className = 'small text-secondary'

        const form = new FormData()
        form.append('resume', f)
        form.append('jobAd', jobAdEl.value)
        form.append('sampleCoverLetter', sampleEl.value)
        form.append('personalInfo', personalInfoEl.value)
        form.append('specialInstructions', specialEl.value)
        form.append('yourName', yourNameEl.value.trim() || '[MY NAME]')

        try {
          const r = await fetch('/api/generate-application-package', { method: 'POST', body: form })
          const j = await r.json()
          if (!r.ok) throw new Error(j.error || 'generation failed')

          parsedResume = j.parsedResume
          parsedOut.textContent = JSON.stringify(j.parsedResume, null, 2)
          extractionOut.textContent = JSON.stringify(j.extraction, null, 2)
          suggestionsOut.textContent = JSON.stringify(j.optimizerSuggestions || [], null, 2)
          coverLetterOut.textContent = j.coverLetter || ''

          const links = []
          if (j.optimizedResumeDocx) links.push(`<a href="${j.optimizedResumeDocx}" target="_blank">Download Optimized DOCX</a>`)
          if (j.optimizedResumeMarkdown) links.push(`<a href="${j.optimizedResumeMarkdown}" target="_blank">View Optimized Markdown</a>`)

          statusEl.innerHTML = `Done (${j.mode}). ${links.join(' | ')}`
          statusEl.className = 'small text-success'
        } catch (e) {
          statusEl.textContent = e.message
          statusEl.className = 'small text-danger'
        }
      })

      loadInfo()
    </script>
  </body>
</html>
